<!DOCTYPE html>
<html lang="en">
<script src="hud.js" defer></script>
<head>
<meta charset="UTF-8" />
<title>Jelly — Cooling (Unified)</title>
<style>
  :root{ --cell:12px; --gap:2px; --bg:#111; }
  *{box-sizing:border-box}
  body{ margin:0; background:var(--bg); height:100vh; display:grid; place-items:center; image-rendering:pixelated; }

  .scene{ display:flex; align-items:center; gap:14px; }
  .grid{ display:grid; gap:var(--gap); }
  .px{ width:var(--cell); height:var(--cell); background:transparent; }

  /* Thermometer 3×6 */
  .thermo{ grid-template-columns:repeat(3,var(--cell)); grid-template-rows:repeat(6,var(--cell)); }
  .tglass{ background:#444; }

  /* Jelly 5×6 */
  .jelly{ grid-template-columns:repeat(5,var(--cell)); grid-template-rows:repeat(6,var(--cell)); }
  .body{ background:#ff6666; transition:background .1s steps(1); }
  .tent{ background:#ff8844; transition:background .1s steps(1); }

  /* Sparkles overlay area */
  .sparkleBox{
    position:relative; width:calc(5*var(--cell) + 4*var(--gap));
    height:calc(6*var(--cell) + 5*var(--gap));
    margin-left:6px; pointer-events:none;
  }
  .sp{ position:absolute; width:var(--cell); height:var(--cell); background:transparent; }
  .on{ background:#c8f4ff; }
</style>
</head>
<body>
  <div class="scene">
    <div class="grid thermo" id="thermo">
      <!-- 3 × 6 glass cells -->
      <!-- Row 0 --><div class="tglass"></div><div class="tglass"></div><div class="tglass"></div>
      <!-- Row 1 --><div class="tglass"></div><div class="tglass"></div><div class="tglass"></div>
      <!-- Row 2 --><div class="tglass"></div><div class="tglass"></div><div class="tglass"></div>
      <!-- Row 3 --><div class="tglass"></div><div class="tglass"></div><div class="tglass"></div>
      <!-- Row 4 --><div class="tglass"></div><div class="tglass"></div><div class="tglass"></div>
      <!-- Row 5 --><div class="tglass"></div><div class="tglass"></div><div class="tglass"></div>
    </div>

    <div style="position:relative; display:flex; align-items:center;">
      <div class="grid jelly" id="jelly">
        <div class="px"></div><div class="body"></div><div class="body"></div><div class="body"></div><div class="px"></div>
        <div class="body"></div><div class="body"></div><div class="body"></div><div class="body"></div><div class="body"></div>
        <div class="body"></div><div class="body"></div><div class="body"></div><div class="body"></div><div class="body"></div>
        <div class="body"></div><div class="body"></div><div class="body"></div><div class="body"></div><div class="body"></div>
        <div class="tent"></div><div class="tent"></div><div class="tent"></div><div class="tent"></div><div class="tent"></div>
        <div class="tent"></div><div class="px"></div><div class="tent"></div><div class="px"></div><div class="tent"></div>
      </div>

      <div class="sparkleBox" id="sparkles">
        <div class="sp" style="left:0;top:0;"></div>
        <div class="sp" style="left:calc(3*var(--cell));top:0;"></div>
        <div class="sp" style="left:calc(1*var(--cell));top:calc(2*var(--cell));"></div>
        <div class="sp" style="left:calc(4*var(--cell));top:calc(1*var(--cell));"></div>
        <div class="sp" style="left:calc(2*var(--cell));top:calc(4*var(--cell));"></div>
      </div>
    </div>
  </div>

<script>
  const phases = [
    { body:'#ff6666', tent:'#ff8844', fill:'#ff6a3a' },
    { body:'#ff7c66', tent:'#ff9950', fill:'#ff7a4e' },
    { body:'#ffa066', tent:'#ffad66', fill:'#ff9b6f' },
    { body:'#ffd166', tent:'#ffc466', fill:'#ffc06e' },
    { body:'#a6e6ff', tent:'#6fc8ff', fill:'#6fc8ff' },
    { body:'#66ccff', tent:'#3399ff', fill:'#3fb2ff' }
  ];
  const bodyPx = Array.from(document.querySelectorAll('.body'));
  const tentPx = Array.from(document.querySelectorAll('.tent'));
  const thermo = Array.from(document.querySelectorAll('#thermo > div'));
  const sparks = Array.from(document.querySelectorAll('#sparkles .sp'));

  const TH_ROWS = 6, TH_COL = 1;
  function setThermo(level, color){
    thermo.forEach(c=>{ c.style.background='#444'; });
    const bulb = (TH_ROWS-1)*3 + TH_COL;
    thermo[bulb].style.background = color;
    const maxTube = TH_ROWS-2;
    for(let r=maxTube; r>=maxTube-level; r--){
      if (r<0) break;
      thermo[r*3+TH_COL].style.background = color;
    }
  }
  function brighten(hex){
    const c=hex.replace('#','');
    const r=parseInt(c.slice(0,2),16), g=parseInt(c.slice(2,4),16), b=parseInt(c.slice(4,6),16);
    const mix=v=>Math.min(255, Math.round(v*0.7+255*0.3));
    return `rgb(${mix(r)},${mix(g)},${mix(b)})`;
  }

  let phase = 0, tActive = true, tentTick = 0;
  function apply(p){
    bodyPx.forEach(b=> b.style.background=p.body);
    tentPx.forEach(t=> t.style.background = tActive ? brighten(p.tent) : p.tent);
    setThermo(phase, p.fill);
  }
  apply(phases[phase]);

  // cooling step cadence unified
  const STEP_MS = 900;
  const timer = setInterval(()=>{
    phase = Math.min(phases.length-1, phase+1);
    tActive = phase < phases.length-2;
    apply(phases[phase]);
    if (phase === phases.length-1) clearInterval(timer), coolBlink=true;
  }, STEP_MS);

  // unified tentacle sway @ 450ms
  function sway(){
    const p = phases[phase];
    const base = p.tent, alt='transparent';
    tentPx.forEach((t,i)=>{
      t.style.background = ((i + tentTick) % 2 === 0) ? (tActive?brighten(base):base) : alt;
    });
    tentTick = (tentTick+1)%2;
  }
  let coolBlink=false;
  function blinkSparkles(on){
    if (!on){ sparks.forEach(s=> s.classList.remove('on')); return; }
    sparks.forEach((s,i)=>{
      if ((i + Math.floor(Date.now()/300)) % 2 === 0) s.classList.add('on');
      else s.classList.remove('on');
    });
  }
  setInterval(()=>{ sway(); blinkSparkles(coolBlink); }, 450);
</script>
</body>
</html>
